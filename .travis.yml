git:
  depth: 1
  quiet: true

language: cpp
stages:
  - build
  - unit

jobs:
  include:
    - os: osx
      stage: build
      env:
        - HOSTING_OS=osx
        - PATH="/usr/local/opt/python/libexec/bin:$PATH"
        - PATH="/usr/local/opt/llvm/bin:$PATH"
        - HOSTING_COMPILER=appleclang
      osx_image: xcode11.3
      addons:
        homebrew:
          update: true
          packages:
            - itk
            - vtk
            - petsc
            - cmake
            - python@3
            - jemalloc
            - tcsh
            - armadillo
            - qt
            - hdf5
            - libomp
            - szip
            - fltk
            - open-mpi
            - eigen
            - ninja
            - git-annex
            - lcov
      cache:
        directories:
          - packages/hpx
          - cmake-build-debug
    - os: linux
      stage: build
      env:
        - HOSTING_OS=trusty
        - HOSTING_COMPILER=gcc
      dist: trusty
      addons:
        apt:
          packages:
            - gfortran
            - libxi-dev
            - liblapack-dev
            - python3.5-dev
            - tcsh
            - curl
            - git
            - cmake
      cache:
        - apt
        - ccache
    - os: linux
      stage: build
      env:
        - HOSTING_OS=xenial
        - HOSTING_COMPILER=gcc
      dist: xenial
      addons:
        apt:
          packages:
            - gfortran
            - libxi-dev
            - liblapack-dev
            - python3.5-dev
            - tcsh
            - curl
            - git
            - cmake
      cache:
        - apt
        - ccache
    - os: linux
      stage: build
      env:
        - HOSTING_OS=bionic
        - HOSTING_COMPILER=gcc
      dist: bionic
      addons:
        apt:
          packages:
            - gfortran
            - libxi-dev
            - liblapack-dev
            - python3.6-dev
            - tcsh
            - curl
            - git
            - cmake
      cache:
        - apt
        - ccache
    - os: linux
      stage: build
      env:
        - HOSTING_OS=trusty
        - HOSTING_COMPILER=clang
        - PATH="/usr/local/clang_9.0.0/bin:$PATH"
        - LD_LIBRARY_PATH="/usr/local/clang_9.0.0/lib:$LD_LIBRARY_PATH"
      dist: trusty
      addons:
        apt:
          packages:
            - gfortran
            - libxi-dev
            - liblapack-dev
            - python3.5-dev
            - tcsh
            - curl
            - git
            - cmake
      cache:
        - apt
        - ccache
    - os: linux
      stage: build
      env:
        - HOSTING_OS=xenial
        - HOSTING_COMPILER=clang
        - PATH="/usr/local/clang_9.0.0/bin:$PATH"
        - LD_LIBRARY_PATH="/usr/local/clang_9.0.0/lib:$LD_LIBRARY_PATH"
      dist: xenial
      addons:
        apt:
          packages:
            - gfortran
            - libxi-dev
            - liblapack-dev
            - python3.5-dev
            - tcsh
            - curl
            - git
            - cmake
      cache:
        - apt
        - ccache
    - os: linux
      stage: build
      env:
        - HOSTING_OS=bionic
        - HOSTING_COMPILER=clang
        - PATH="/usr/local/clang_9.0.0/bin:$PATH"
        - LD_LIBRARY_PATH="/usr/local/clang_9.0.0/lib:$LD_LIBRARY_PATH"
      dist: bionic
      addons:
        apt:
          packages:
            - gfortran
            - libxi-dev
            - liblapack-dev
            - python3.6-dev
            - tcsh
            - curl
            - git
            - cmake
      cache:
        - apt
        - ccache
    - os: osx
      stage: build
      env:
        - HOSTING_OS=osx
        - PATH="/usr/local/opt/python/libexec/bin:$PATH"
        - HOSTING_COMPILER=clang
        - PATH="/usr/local/opt/llvm/bin:$PATH"
        - LDFLAGS="-L/usr/local/opt/llvm/lib"
        - CPPFLAGS="-I/usr/local/opt/llvm/include"
        - CC=/usr/local/opt/llvm/bin/clang
        - CXX=/usr/local/opt/llvm/bin/clang++
      osx_image: xcode11.3
      addons:
        homebrew:
          update: true
          packages:
            - itk
            - vtk
            - petsc
            - cmake
            - python@3
            - jemalloc
            - tcsh
            - armadillo
            - qt
            - hdf5
            - libomp
            - szip
            - fltk
            - open-mpi
            - eigen
            - ninja
            - llvm
      cache:
        directories:
          - packages/hpx
          - cmake-build-debug
    - os: osx
      stage: build
      env:
        - HOSTING_OS=osx
        - PATH="/usr/local/opt/python/libexec/bin:$PATH"
        - PATH="/usr/local/opt/gcc/bin:$PATH"
        - HOSTING_COMPILER=gcc
        - CC=gcc-9
        - CXX=g++-9
      osx_image: xcode11.3
      addons:
        homebrew:
          update: true
          packages:
            - itk
            - vtk
            - petsc
            - cmake
            - python@3
            - gcc@9
            - jemalloc
            - tcsh
            - armadillo
            - qt
            - hdf5
            - libomp
            - szip
            - fltk
            - open-mpi
            - eigen
            - ninja
      cache:
        directories:
          - packages/hpx
          - cmake-build-debug
    - os: osx
      stage: unit
      env:
        - HOSTING_OS=osx
        - PATH="/usr/local/opt/python/libexec/bin:$PATH"
        - PATH="/usr/local/opt/llvm/bin:$PATH"
        - HOSTING_COMPILER=appleclang
      osx_image: xcode11.3
      addons:
        homebrew:
          update: true
          packages:
            - itk
            - vtk
            - petsc
            - cmake
            - python@3
            - jemalloc
            - tcsh
            - armadillo
            - qt
            - hdf5
            - libomp
            - szip
            - fltk
            - open-mpi
            - eigen
            - ninja
            - lcov
            - git-annex
      cache:
        directories:
          - packages/hpx
          - cmake-build-debug

before_install:
  - ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.${TRAVIS_BUILD_STAGE_NAME}.sh

script:
  - ./ci-scripts/travis.script.${HOSTING_OS}.${TRAVIS_BUILD_STAGE_NAME}.sh

after_success:
  - if [[ $TRAVIS_BUILD_STAGE_NAME == "Unit" ]]; then cd ./cmake-build-debug && rm -f ./**/testdata.tar.gz; fi
  - if [[ $TRAVIS_BUILD_STAGE_NAME == "Unit" ]]; then lcov --capture --directory ./cmake-build-debug/ --output-file ./coverage.info; fi
  - if [[ $TRAVIS_BUILD_STAGE_NAME == "Unit" ]]; then bash <(curl -s https://codecov.io/bash) -f ./coverage.info -t ${CODECOV_TOKEN}; fi

#before_install:
#  - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
#  - sudo apt-get -q update
#  - sudo apt-get -y install gcc-9
#  - sudo apt-get -y install gfortran-9
#  - sudo apt-get -y install cmake
#  - sudo apt-get -y install python3.7-dev
#  - sudo apt-get -y install libxi-dev
#  - sudo apt-get -y install liblapack-dev
#  - sudo apt-get -y install tcsh
#  - sudo apt-get -y install curl
#  - sudo apt-get -y install git
#  - sudo apt-get -y install libx11-dev

