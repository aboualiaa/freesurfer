# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

name: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - fs-modernize

stages:
  - stage: Lint
    jobs:
      - job: LinuxLint
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: sudo apt-get update -y
          - script: sudo apt-get install -y libxml2-utils
          - script: xmllint --noout ./**/*.xml
        displayName: 'Linting'

# MARK: -

  - stage: BionicClang
    dependsOn: Lint
    jobs:
      - job: BionicDebugClang_Coverage
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build Clang + Coverage'
      - job: BionicReleaseClang_ASAN
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build Clang + ASAN'
      - job: BionicReleaseClang_TSAN
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build Clang + TSAN'
      - job: BionicReleaseClang_UBSAN
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build Clang + UBSAN'
      - job: BionicReleaseClang_MSAN
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build Clang + MSAN'
      - job: BionicReleaseClang_CFISAN
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build Clang + CFISAN'
# MARK: -

  - stage: XenialClang
    dependsOn: Lint
    jobs:
      - job: XenialDebugClang_Coverage
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build Clang + Coverage'
      - job: XenialReleaseClang_ASAN
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build Clang + ASAN'
      - job: XenialReleaseClang_TSAN
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build Clang + TSAN'
      - job: XenialReleaseClang_UBSAN
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build Clang + UBSAN'
      - job: XenialReleaseClang_MSAN
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build Clang + MSAN'
      - job: XenialReleaseClang_CFISAN
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: clang
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build Clang + CFISAN'

# MARK: -

  - stage: BionicGCC
    dependsOn: Lint
    jobs:
      - job: BionicDebugGCC_Coverage
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build GCC + Coverage'
      - job: BionicReleaseGCC_ASAN
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build GCC + ASAN'
      - job: BionicReleaseGCC_TSAN
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build GCC + TSAN'
      - job: BionicReleaseGCC_UBSAN
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build GCC + UBSAN'
      - job: BionicReleaseGCC_MSAN
        variables:
          HOSTING_OS: bionic
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Bionic Build GCC + MSAN'


# MARK: -

  - stage: XenialGCC
    dependsOn: Lint
    jobs:
      - job: XenialDebugGCC_Coverage
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build GCC + Coverage'
      - job: XenialReleaseGCC_ASAN
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build GCC + ASAN'
      - job: XenialReleaseGCC_TSAN
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build GCC + TSAN'
      - job: XenialReleaseGCC_UBSAN
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial Build GCC + UBSAN'
      - job: XenialReleaseGCC_MSAN
        variables:
          HOSTING_OS: xenial
          HOSTING_COMPILER: gcc
          TESTING_TYPE: '_Unit_Tests'
          AZURE_SOURCE_DIR: '$(Build.SourcesDirectory)/distribution'
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'specific'
              project: '1eee1365-4e03-49ce-a8e3-c84dd1212c9e'
              definition: '3'
              buildVersionToDownload: 'latest'
              artifactName: 'GitAnnex'
              targetPath: '$(Agent.BuildDirectory)/GitAnnex'
          - checkout: self
            submodules: true
          - script: |
              ./ci-scripts/install_deps.sh $HOSTING_OS $HOSTING_COMPILER
              export TESTING_TYPE
              git remote add cache ../GitAnnex
              git annex copy --from cache
            displayName: 'Setting up Git Annex'
          - script: |
              ./ci-scripts/travis.configure.${HOSTING_OS}.${HOSTING_COMPILER}.Build.sh
              ./ci-scripts/travis.script.${HOSTING_OS}.Build.sh
              rm -rf ../GitAnnex
            displayName: 'Building'
          - script: |
              echo $AZURE_SOURCE_DIR
              export AZURE_SOURCE_DIR
              ./ci-scripts/travis.script.${HOSTING_OS}.Unit.sh $HOSTING_COMPILER
            displayName: 'Unit Testing'
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'cTest'
              testResultsFiles: '**/Test.xml'
              testRunTitle: 'cTest-$(HOSTING_OS)-$(HOSTING_COMPILER)-UnitTests'
        displayName: 'Ubuntu Xenial GCC Clang + MSAN'

  - stage: TestInstallationXenial
    dependsOn:
      - XenialGCC
      - XenialClang
    condition: succeeded()
    jobs:
      - job: XenialInstallationTest
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
          - checkout: none
          - script: echo "whassup"
        displayName: 'Testing Xenial Installation'

  - stage: TestInstallationBionic
    dependsOn:
      - BionicGCC
      - BionicClang
    condition: succeeded()
    jobs:
      - job: BionicInstallationTest
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - checkut: none
          - script: echo "whassup"
        displayName: 'Testing Bionic Installation'
